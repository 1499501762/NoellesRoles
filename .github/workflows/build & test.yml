name: Build and Test

on:
  push:
    branches:
      - '**'
  pull_request:

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 21 with Gradle cache
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'
          cache: gradle

      - name: Ensure jq is available
        run: |
          if ! command -v jq >/dev/null 2>&1; then
            sudo apt-get update -y
            sudo apt-get install -y jq
          else
            echo "jq already installed: $(jq --version)"
          fi

      - name: Prepare libs directory
        run: mkdir -p libs

      - name: Read versions from gradle.properties
        id: read-versions
        run: |
          WATHE_VER=$(grep '^wathe_version=' gradle.properties | cut -d'=' -f2 | tr -d '\r')
          HARP_VER=$(grep '^harpymodloader_version=' gradle.properties | cut -d'=' -f2 | tr -d '\r')
          echo "wathe_version=$WATHE_VER" >> "$GITHUB_OUTPUT"
          echo "harp_version=$HARP_VER" >> "$GITHUB_OUTPUT"
          echo "ðŸ“‹ Read from gradle.properties:"
          echo "  wathe: $WATHE_VER"
          echo "  harpymodloader: $HARP_VER"

      - name: Download wathe from Modrinth (try specified or fallback to GitHub)
        id: get-wathe
        shell: bash
        env:
          WATHE_WANT_VER: ${{ steps.read-versions.outputs.wathe_version }}
          WATHE_GITHUB_FALLBACK: https://github.com/doctor4t/Wathe/releases/download/1.3-1.21.1/wathe-1.3-1.21.1.jar
        run: |
          set -e
          SLUG="wathe"
          API="https://api.modrinth.com/v2/project/${SLUG}/version"
          WANT="${WATHE_WANT_VER}"
          echo "Querying Modrinth for ${SLUG} version ${WANT}..."
          raw=$(curl -s "$API")
          if [ -z "$raw" ] || [ "$raw" = "null" ]; then
            echo "âš  Modrinth API returned empty or null; will use GitHub fallback"
            chosen_url="${WATHE_GITHUB_FALLBACK}"
            chosen_ver="fallback"
          else
            # Try to find exact version match
            entry=$(echo "$raw" | jq -r --arg want "$WANT" 'map(select(.version_number==$want)) | .[0]')
            if [ -z "$entry" ] || [ "$entry" = "null" ]; then
              echo "âš  Exact version ${WANT} not found; using latest version from Modrinth"
              entry=$(echo "$raw" | jq -r '.[0]')
            fi
            
            if [ -z "$entry" ] || [ "$entry" = "null" ]; then
              echo "âš  No versions available on Modrinth; falling back to GitHub"
              chosen_url="${WATHE_GITHUB_FALLBACK}"
              chosen_ver="fallback"
            else
              chosen_ver=$(echo "$entry" | jq -r '.version_number // empty')
              chosen_url=$(echo "$entry" | jq -r '.files[0].url // empty')
              if [ -z "$chosen_url" ]; then
                echo "âš  Modrinth entry has no file URL; falling back to GitHub"
                chosen_url="${WATHE_GITHUB_FALLBACK}"
                chosen_ver="fallback"
              fi
            fi
          fi
          
          outname="libs/wathe-${{ steps.read-versions.outputs.wathe_version }}.jar"
          echo "Downloading wathe (${chosen_ver}) from: $chosen_url"
          if ! curl -L -f -o "$outname" "$chosen_url"; then
            echo "âŒ Failed to download wathe from: $chosen_url" >&2
            exit 1
          fi
          echo "âœ“ wathe downloaded to $outname"
          echo "wathe_version=$chosen_ver" >> "$GITHUB_OUTPUT"

      - name: Download harpymodloader from Modrinth (try specified or use latest)
        id: get-harp
        shell: bash
        env:
          HARP_WANT_VER: ${{ steps.read-versions.outputs.harp_version }}
        run: |
          set -e
          SLUG="harpymodloader"
          API="https://api.modrinth.com/v2/project/${SLUG}/version"
          WANT="${HARP_WANT_VER}"
          echo "Querying Modrinth for ${SLUG} version ${WANT}..."
          raw=$(curl -s "$API")
          if [ -z "$raw" ] || [ "$raw" = "null" ]; then
            echo "âŒ Modrinth API returned empty or null for ${SLUG}" >&2
            exit 1
          fi
          
          # Try to find exact version match
          entry=$(echo "$raw" | jq -r --arg want "$WANT" 'map(select(.version_number==$want)) | .[0]')
          if [ -z "$entry" ] || [ "$entry" = "null" ]; then
            echo "âš  Exact version ${WANT} not found; using latest version from Modrinth"
            entry=$(echo "$raw" | jq -r '.[0]')
          fi
          
          if [ -z "$entry" ] || [ "$entry" = "null" ]; then
            echo "âŒ No versions available on Modrinth for ${SLUG}" >&2
            exit 1
          fi
          
          chosen_ver=$(echo "$entry" | jq -r '.version_number // empty')
          chosen_url=$(echo "$entry" | jq -r '.files[0].url // empty')
          
          if [ -z "$chosen_url" ]; then
            echo "âŒ Modrinth entry has no file URL for ${SLUG}" >&2
            exit 1
          fi
          
          outname="libs/harpymodloader-${{ steps.read-versions.outputs.harp_version }}.jar"
          echo "Downloading harpymodloader (${chosen_ver}) from: $chosen_url"
          if ! curl -L -f -o "$outname" "$chosen_url"; then
            echo "âŒ Failed to download harpymodloader from: $chosen_url" >&2
            exit 1
          fi
          echo "âœ“ harpymodloader downloaded to $outname"
          echo "harp_version=$chosen_ver" >> "$GITHUB_OUTPUT"

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build
        run: ./gradlew --no-daemon clean build

      - name: Summary
        if: success()
        run: |
          echo "ðŸŽ‰ Build succeeded!"
          echo ""
          echo "ðŸ“¦ Artifacts:"
          ls -lh build/libs/*.jar 2>/dev/null || echo "  (no JARs found)"
          echo ""
          echo "ðŸ“Š Dependencies used:"
          echo "  - wathe: ${{ steps.get-wathe.outputs.wathe_version }}"
          echo "  - harpymodloader: ${{ steps.get-harp.outputs.harp_version }}"

      - name: Upload build artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts-${{ github.run_id }}
          path: |
            build/libs/*.jar
            build/reports/
          retention-days: 7
          if-no-files-found: ignore

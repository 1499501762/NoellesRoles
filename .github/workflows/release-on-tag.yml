name: Release on tag

on:
  push:
    tags:
      - 'v*'
      - 'V*'
      - '*.*.*'

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '21'

      - name: Setup Gradle (cache disabled)
        uses: gradle/actions/setup-gradle@v3
        with:
          cache-disabled: true

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Ensure jq is available
        run: |
          if ! command -v jq >/dev/null 2>&1; then
            sudo apt-get update -y
            sudo apt-get install -y jq
          fi

      - name: Prepare libs directory
        run: mkdir -p libs

      - name: Download harpymodloader from Modrinth and determine dep suffix
        id: get-harp
        shell: bash
        env:
          HARP_WANT_VER: ${{ vars.HARP_WANT_VER }}
        run: |
          set -e
          SLUG="harpymodloader"
          API="https://api.modrinth.com/v2/project/${SLUG}/version"
          WANT="${HARP_WANT_VER}"
          raw=$(curl -s "$API")
          if [ -z "$raw" ] || [ "$raw" = "null" ]; then
            echo "harp_file=none" >> "$GITHUB_OUTPUT"
            echo "harp_version=unknown" >> "$GITHUB_OUTPUT"
            echo "dep=hunknown" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          if [ -n "$WANT" ]; then
            entry=$(echo "$raw" | jq -r --arg want "$WANT" 'map(select(.version_number==$want)) | .[0]')
          fi
          if [ -z "$entry" ] || [ "$entry" = "null" ]; then
            entry=$(echo "$raw" | jq -r '.[0]')
          fi
          if [ -z "$entry" ] || [ "$entry" = "null" ]; then
            echo "harp_file=none" >> "$GITHUB_OUTPUT"
            echo "harp_version=unknown" >> "$GITHUB_OUTPUT"
            echo "dep=hunknown" >> "$GITHUB_OUTPUT"
            exit 0
          fi
          version_number=$(echo "$entry" | jq -r '.version_number // empty')
          file_url=$(echo "$entry" | jq -r '.files[0].url // empty')
          dep="h${version_number}"
          if [[ "$version_number" =~ (h[0-9]+(\.[0-9]+)*) ]]; then
            dep="${BASH_REMATCH[1]}"
          else
            if [[ "$version_number" =~ -?(h[0-9]+(\.[0-9]+)*) ]]; then
              dep="${BASH_REMATCH[1]}"
            fi
          fi
          dep="$(echo "$dep" | sed 's/[^h0-9\.]//g')"
          if [ -n "$file_url" ]; then
            # Write directly to Gradle's expected path to avoid later renames
            outname="libs/harpymodloader-1.1.2-h1.3.jar"
            echo "Downloading harpymodloader: $file_url -> $outname"
            curl -L -s -o "$outname" "$file_url"
            echo "harp_file=$outname" >> "$GITHUB_OUTPUT"
          else
            echo "harp_file=none" >> "$GITHUB_OUTPUT"
          fi
          echo "harp_version=$version_number" >> "$GITHUB_OUTPUT"
          echo "dep=$dep" >> "$GITHUB_OUTPUT"

      - name: Download wathe from Modrinth (try specified or fallback to GitHub release)
        id: get-wathe
        shell: bash
        env:
          WATHE_WANT_VER: ${{ vars.WATHE_WANT_VER }}
          WATHE_GITHUB_FALLBACK: ${{ secrets.WATHE_GITHUB_FALLBACK }}
        run: |
          set -e
          SLUG="wathe"
          API="https://api.modrinth.com/v2/project/${SLUG}/version"
          WANT="${WATHE_WANT_VER}"
          raw=$(curl -s "$API")
          chosen_url=""
          chosen_ver=""
          if [ -n "$raw" ] && [ "$raw" != "null" ]; then
            if [ -n "$WANT" ]; then
              entry=$(echo "$raw" | jq -r --arg want "$WANT" 'map(select(.version_number==$want)) | .[0]')
            fi
            if [ -z "$entry" ] || [ "$entry" = "null" ]; then
              entry=$(echo "$raw" | jq -r '.[0]')
            fi
            if [ -n "$entry" ] && [ "$entry" != "null" ]; then
              chosen_ver=$(echo "$entry" | jq -r '.version_number // empty')
              chosen_url=$(echo "$entry" | jq -r '.files[0].url // empty')
            fi
          fi
          if [ -z "$chosen_url" ]; then
            echo "Modrinth did not provide wathe file; falling back to GitHub release URL"
            chosen_url="${WATHE_GITHUB_FALLBACK}"
            chosen_ver=""
          fi
          # Always write to Gradle's expected path to avoid later renames
          outname="libs/wathe-1.3.2-1.21.1.jar"
          echo "Downloading wathe: $chosen_url -> $outname"
          curl -L -s -o "$outname" "$chosen_url"
          echo "wathe_file=$outname" >> "$GITHUB_OUTPUT"
          echo "wathe_version=$chosen_ver" >> "$GITHUB_OUTPUT"

      - name: Verify libs files before build
        run: |
          echo "ðŸ“ Libs directory contents:"
          ls -lh libs/ || echo "  (libs dir empty or missing)"
          echo ""
          echo "ðŸ“‹ Gradle will use:"
          file libs/wathe-1.3.2-1.21.1.jar && echo "âœ“ wathe JAR found" || echo "âŒ wathe JAR missing"
          file libs/harpymodloader-1.1.2-h1.3.jar && echo "âœ“ harpymodloader JAR found" || echo "âŒ harpymodloader JAR missing"

      - name: Build with Gradle
        run: ./gradlew --no-daemon clean build --info 2>&1 | tee build.log

      - name: Check build results
        if: always()
        run: |
          echo "ðŸ“Š Build artifacts:"
          find build/libs -name '*.jar' -type f 2>/dev/null | while read f; do
            echo "  - $(basename $f) ($(du -h $f | cut -f1))"
          done || echo "  (no JARs produced)"
          echo ""
          if [ -f build.log ]; then
            echo "ðŸ“ Last 40 lines of build log:"
            tail -40 build.log
          fi

      - name: Collect release files
        run: |
          mkdir -p release
          jar_count=$(find build/libs -name '*.jar' -type f 2>/dev/null | wc -l)
          echo "Found $jar_count JAR file(s)"
          if [ $jar_count -eq 0 ]; then
            echo "âŒ No JAR files produced by build!" >&2
            exit 1
          fi
          cp -v build/libs/*.jar release/
          echo "ðŸ“¦ Release artifacts:"
          ls -lh release/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          draft: false
          prerelease: ${{ contains(github.ref_name, 'alpha') || contains(github.ref_name, 'beta') || contains(github.ref_name, 'rc') }}
          generate_release_notes: true
          files: |
            release/*.jar
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
